<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Web Auth</title>

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/milligram/1.3.0/milligram.css">

    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .page-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            padding-top: 48px;
            max-width: 1000px;
        }
    </style>
</head>

<body>

<div class="page-container">
    Username:
    <input id="txt-username">
    <button id=btn-register>Register</button>
    <button id=btn-login>Login</button>
</div>

<script type="module">
    import {postJson, publicKeyCredentialToJSON} from "./utils.js";
    import {decode, encode} from "./base64url-arraybuffer.js"

    window.onload = () => {
        const registerButton = document.getElementById('btn-register');
        registerButton.addEventListener('click', () => {
            register()
        });

        const loginButton = document.getElementById('btn-login');
        loginButton.addEventListener('click', () => {
            login()
        })
    };

    async function register() {
        // send username to server, check if user is registered
        // if yes, return error and let them log in,
        // if not send back random challenge
        const body = {
            username: document.getElementById('txt-username').value
        };
        const registrationResponse = await postJson('/register', body);
        if (registrationResponse.status !== 'ok') {
            alert(registrationResponse.message)
        } else {
            console.log(registrationResponse);

            // these fields need to be byte arrays instead of strings
            registrationResponse.challenge = decode(registrationResponse.challenge);
            registrationResponse.user.id = decode(registrationResponse.user.id);

            const publicKeyCredential = await navigator.credentials.create({publicKey: registrationResponse});
            const publicKeyCredentialJson = publicKeyCredentialToJSON(publicKeyCredential);

            const resisterResponse = await postJson('/verify-registration', publicKeyCredentialJson);
            if (resisterResponse.status !== 'ok') {
                alert(resisterResponse.message)
            }
        }

    }

    async function login() {
        const body = {
            username: document.getElementById('txt-username').value
        };

        const loginResponse = await postJson('/login', body);
        if (loginResponse.status !== 'ok') {
            alert(loginResponse.message)
        } else {

            delete loginResponse.status
            loginResponse.challenge = decode(loginResponse.challenge);

            for(let allowCred of loginResponse.allowCredentials) {
                console.log("allowed cred ID: ", allowCred.id)

                allowCred.id = decode(allowCred.id);
            }

            console.log('Trying to get credential:')
            console.log(loginResponse)

            const cred = await navigator.credentials.get({publicKey: loginResponse});
            console.log('found cred: ')
            console.log(cred)
            let getAssertionResponse = publicKeyCredentialToJSON(cred);
            const result = await postJson('/verify-login', getAssertionResponse);


            if (result.status !== 'ok') {
                alert(`Server responed with error. The message is: ${result.message}`);
            }
        }
    }

</script>


</body>

</html>
